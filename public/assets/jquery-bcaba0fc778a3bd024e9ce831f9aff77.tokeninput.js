/*
 * jQuery Plugin: Tokenizing Autocomplete Text Entry
 * Version 1.4.2
 *
 * Copyright (c) 2009 James Smith (http://loopj.com)
 * Licensed jointly under the GPL and MIT licenses,
 * choose which one suits your project best!
 *
 */
(function(a){var b={hintText:"Type in a search term",noResultsText:"No results",searchingText:"Searching...",deleteText:"&times;",searchDelay:300,minChars:1,tokenLimit:null,jsonContainer:null,method:"GET",contentType:"json",queryParam:"q",tokenDelimiter:",",preventDuplicates:!1,prePopulate:null,processPrePopulate:!1,animateDropdown:!0,onResult:null,onAdd:null,onDelete:null},c={tokenList:"token-input-list",token:"token-input-token",tokenDelete:"token-input-delete-token",selectedToken:"token-input-selected-token",highlightedToken:"token-input-highlighted-token",dropdown:"token-input-dropdown",dropdownItem:"token-input-dropdown-item",dropdownItem2:"token-input-dropdown-item2",selectedDropdownItem:"token-input-selected-dropdown-item",inputToken:"token-input-input-token"},d={BEFORE:0,AFTER:1,END:2},e={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUMPAD_ENTER:108,COMMA:188};a.fn.tokenInput=function(c,d){var e=a.extend({},b,d||{});return this.each(function(){new a.TokenList(this,c,e)})},a.TokenList=function(b,f,g){function w(){if(l===(l=m.val()))return;var a=l.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");u.html(a),m.width(u.width()+30)}function x(a){return a>=48&&a<=90||a>=96&&a<=111||a>=186&&a<=192||a>=219&&a<=222}function y(b,c){var d=a("<li><p>"+c+"</p></li>").addClass(g.classes.token).insertBefore(s);a("<span>"+g.deleteText+"</span>").addClass(g.classes.tokenDelete).appendTo(d).click(function(){return D(a(this).parent()),!1});var e={id:b,name:c};a.data(d.get(0),"tokeninput",e),h=h.slice(0,p).concat([e]).concat(h.slice(p)),p++;var f=a.map(h,function(a){return a.id});return n.val(f.join(g.tokenDelimiter)),i+=1,d}function z(b){var c=a.data(b.get(0),"tokeninput"),d=g.onAdd;if(i>0&&g.preventDuplicates){var e=null;r.children().each(function(){var b=a(this),d=a.data(b.get(0),"tokeninput");if(d&&d.id===c.id)return e=b,!1});if(e){A(e),s.insertAfter(e),m.focus();return}}y(c.id,c.name);if(g.tokenLimit!==null&&i>=g.tokenLimit){m.hide(),E();return}m.focus(),m.val(""),E(),a.isFunction(d)&&d.call(n,c)}function A(a){a.addClass(g.classes.selectedToken),o=a.get(0),m.val(""),E()}function B(a,b){a.removeClass(g.classes.selectedToken),o=null,b===d.BEFORE?(s.insertBefore(a),p--):b===d.AFTER?(s.insertAfter(a),p++):(s.appendTo(r),p=i),m.focus()}function C(b){var c=o;o&&B(a(o),d.END),c===b.get(0)?B(b,d.END):A(b)}function D(b){var c=a.data(b.get(0),"tokeninput"),d=g.onDelete,e=b.prevAll().length;e>p&&e--,b.remove(),o=null,m.focus(),h=h.slice(0,e).concat(h.slice(e+1)),e<p&&p--;var f=a.map(h,function(a){return a.id});n.val(f.join(g.tokenDelimiter)),i-=1,g.tokenLimit!==null&&m.show().val("").focus(),a.isFunction(d)&&d.call(n,c)}function E(){t.hide().empty(),q=null}function F(){t.css({position:"absolute",top:a(r).offset().top+a(r).outerHeight(),left:a(r).offset().left,zindex:999}).show()}function G(){g.searchingText&&(t.html("<p>"+g.searchingText+"</p>"),F())}function H(){g.hintText&&(t.html("<p>"+g.hintText+"</p>"),F())}function I(a,b){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+b+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>")}function J(b,c){if(c&&c.length){t.empty();var d=a("<ul>").appendTo(t).mouseover(function(b){K(a(b.target).closest("li"))}).mousedown(function(b){return z(a(b.target).closest("li")),!1}).hide();a.each(c,function(c,e){var f=a("<li>"+I(e.name,b)+"</li>").appendTo(d);c%2?f.addClass(g.classes.dropdownItem):f.addClass(g.classes.dropdownItem2),c===0&&K(f),a.data(f.get(0),"tokeninput",{id:e.id,name:e.name})}),F(),g.animateDropdown?d.slideDown("fast"):d.show()}else g.noResultsText&&(t.html("<p>"+g.noResultsText+"</p>"),F())}function K(b){b&&(q&&L(a(q)),b.addClass(g.classes.selectedDropdownItem),q=b.get(0))}function L(a){a.removeClass(g.classes.selectedDropdownItem),q=null}function M(){var b=m.val().toLowerCase();b&&b.length&&(o&&B(a(o),d.AFTER),b.length>=g.minChars?(G(),clearTimeout(k),k=setTimeout(function(){N(b)},g.searchDelay)):E())}function N(b){var c=j.get(b);if(c)J(b,c);else if(g.url){var d={};d.data={};if(g.url.indexOf("?")>-1){var e=g.url.split("?");d.url=e[0];var f=e[1].split("&");a.each(f,function(a,b){var c=b.split("=");d.data[c[0]]=c[1]})}else d.url=g.url;d.data[g.queryParam]=b,d.type=g.method,d.dataType=g.contentType,g.crossDomain&&(d.dataType="jsonp"),d.success=function(c){a.isFunction(g.onResult)&&(c=g.onResult.call(n,c)),j.add(b,g.jsonContainer?c[g.jsonContainer]:c),m.val().toLowerCase()===b&&J(b,g.jsonContainer?c[g.jsonContainer]:c)},a.ajax(d)}else if(g.local_data){var h=a.grep(g.local_data,function(a){return a.name.toLowerCase().indexOf(b.toLowerCase())>-1});a.isFunction(g.onResult)&&(h=g.onResult.call(n,h)),j.add(b,h),J(b,h)}}typeof f=="string"?(g.url=f,g.crossDomain===undefined&&(g.url.indexOf("://")===-1?g.crossDomain=!1:g.crossDomain=location.href.split(/\/+/g)[1]!==g.url.split(/\/+/g)[1])):typeof f=="object"&&(g.local_data=f),g.classes?g.classes=a.extend({},c,g.classes):g.theme?(g.classes={},a.each(c,function(a,b){g.classes[a]=b+"-"+g.theme})):g.classes=c;var h=[],i=0,j=new a.TokenList.Cache,k,l,m=a('<input type="text"  autocomplete="off">').css({outline:"none"}).focus(function(){(g.tokenLimit===null||g.tokenLimit!==i)&&H()}).blur(function(){E()}).bind("keyup keydown blur update",w).keydown(function(b){var c,f;switch(b.keyCode){case e.LEFT:case e.RIGHT:case e.UP:case e.DOWN:if(!a(this).val())c=s.prev(),f=s.next(),c.length&&c.get(0)===o||f.length&&f.get(0)===o?b.keyCode===e.LEFT||b.keyCode===e.UP?B(a(o),d.BEFORE):B(a(o),d.AFTER):b.keyCode!==e.LEFT&&b.keyCode!==e.UP||!c.length?(b.keyCode===e.RIGHT||b.keyCode===e.DOWN)&&f.length&&A(a(f.get(0))):A(a(c.get(0)));else{var g=null;return b.keyCode===e.DOWN||b.keyCode===e.RIGHT?g=a(q).next():g=a(q).prev(),g.length&&K(g),!1}break;case e.BACKSPACE:c=s.prev();if(!a(this).val().length)return o?D(a(o)):c.length&&A(a(c.get(0))),!1;a(this).val().length===1?E():setTimeout(function(){M()},5);break;case e.TAB:case e.ENTER:case e.NUMPAD_ENTER:case e.COMMA:if(q)return z(a(q)),!1;break;case e.ESCAPE:return E(),!0;default:String.fromCharCode(b.which)&&setTimeout(function(){M()},5)}}),n=a(b).hide().val("").focus(function(){m.focus()}).blur(function(){m.blur()}),o=null,p=0,q=null,r=a("<ul />").addClass(g.classes.tokenList).click(function(b){var c=a(b.target).closest("li");c&&c.get(0)&&a.data(c.get(0),"tokeninput")?C(c):(o&&B(a(o),d.END),m.focus())}).mouseover(function(b){var c=a(b.target).closest("li");c&&o!==this&&c.addClass(g.classes.highlightedToken)}).mouseout(function(b){var c=a(b.target).closest("li");c&&o!==this&&c.removeClass(g.classes.highlightedToken)}).insertBefore(n),s=a("<li />").addClass(g.classes.inputToken).appendTo(r).append(m),t=a("<div>").addClass(g.classes.dropdown).appendTo("body").hide(),u=a("<tester/>").insertAfter(m).css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:m.css("fontSize"),fontFamily:m.css("fontFamily"),fontWeight:m.css("fontWeight"),letterSpacing:m.css("letterSpacing"),whiteSpace:"nowrap"});n.val("");var v=g.prePopulate||n.data("pre");g.processPrePopulate&&a.isFunction(g.onResult)&&(v=g.onResult.call(n,v)),v&&v.length&&a.each(v,function(a,b){y(b.id,b.name)})},a.TokenList.Cache=function(b){var c=a.extend({max_size:500},b),d={},e=0,f=function(){d={},e=0};this.add=function(a,b){e>c.max_size&&f(),d[a]||(e+=1),d[a]=b},this.get=function(a){return d[a]}}})(jQuery)