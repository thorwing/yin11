<div class="grid_9 to_left">
    <div class="box_shadow p5">
        <% if @recipe.image.present? %>
            <%= link_to image_tag("grey.gif", :alt=> @recipe.name, "class" => 'lazy fl img_frame overflow_hidden', "data-original"=>  @recipe.get_image_url(:waterfall) ), @recipe.get_image_url, rel: "facebox"  %>
        <% else %>
            <%= image_tag "grey.gif", "data-original"=> "/assets/not_found.png", class: 'lazy fl img_frame overflow_hidden' %>
        <% end %>

        <div class="clearfix">
            <div class="fl ml10 clearfix" style="width:470px">
                <div>
                    <span class="f28"><%= @recipe.name %></span><br/>
                    <span class="trivial"><%= t("recipes.published_at") %> <%= @recipe.created_at.strftime("%y-%m-%d %H:%M:%S") %></span>

                    <% titlestr = "我发现一个不错的菜谱《"+ @recipe.name + "》: ”" + truncate_content(@recipe.description,30) + "”。" %>
                    <% summarystr = "大家去看看吧！" %>
                    <% picstr = "http://" + request.host_with_port + @recipe.get_image_url(:waterfall) %>
                    <% appkeyhash = load_appkey() %>
                    <%= render "shared/jiathis", :titlestr => titlestr, :summarystr => summarystr, :picstr => picstr, :appkeyhash => appkeyhash %>
                </div>

                <div class="mt10">
                    <% if current_user_has_permission? :normal_user %>
                        <div class="mt5">
                            <%= render "votes/vote_fields", :item => @recipe %>
                        </div>
                        <div class="mt5">
                            <%= link_to "", "", class: "mark_recipe want_do_btn", "data-behavior" => "want", "data-msg" => "我#{t("recipes.want")}#{@recipe.name}" %>
                            <%= link_to "", "", class: "mark_recipe done_btn", "data-behavior" => "did", "data-msg" => "我#{t("recipes.did")}#{@recipe.name}"  %>
                        </div>
                    <% end %>
                    <% if the_author_himself(Recipe.name, @recipe.id, true, false) %>
                        <div class="mt5">
                            <%= link_to "", edit_recipe_path(@recipe), class: "modify_btn" if the_author_himself(Recipe.name, @recipe.id, true, false) %>
                            <%= link_to "", @recipe, :confirm => t("general.are_you_sure_to_delete"), :method => :delete, :class => "delete_btn" %>
                        </div>
                    <% end %>
                </div>

                <div class="mt10">
                    <b><%= t("recipes.tags") %></b>
                    <%= render "shared/show_tags", item: @recipe %>
                </div>

                <div class="mt10">
                    <div class="clearfix">
                        <b><%= t_with_colon("recipes.major") if @recipe.major_ingredients.length >0 %></b>
                        <ul>
                            <% @recipe.major_ingredients.each do |i|%>
                                <li class="fl" style="width:50%;"> <%= i.name %>  <span class="trivial"><%= i.amount %></span></li>
                            <% end %>
                        </ul>
                    </div>
                    <div class="clearfix">
                        <b><%= t_with_colon("recipes.minor") if @recipe.minor_ingredients.length >0%></b>
                        <ul>
                            <% @recipe.minor_ingredients.each do |i|%>
                                <li class="fl" style="width:50%;"> <%= i.name %> <span class="trivial"><%= i.amount %></span></li>
                            <% end %>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="clearfix"></div>
            <% if @recipe.description.present? %>
                <div  class="mt5">
                    <b ><%= t("recipes.description") %></b><br/>
                    <%= @recipe.description %>
                </div>
            <% end %>

            <div class="fl mt10 block">
                <% @recipe.steps.each_slice(3).each do |slice| %>
                    <div class="clearfix">
                     <% slice.each do |s| %>
                        <div class="fl ml10 mr10 mb5" style="width:205px">
                            <b><%= @recipe.steps.index(s) + 1 %></b><br/>
                            <span class="center">
                                <% if s.image.present?%>
                                    <!--<img class="lazy" src="grey.gif" data-original= "<=s.get_image_url%>" width="180" heigh="135" rel="facebox" :alt="step_image"  >-->
                                    <%= link_to image_tag("grey.gif", :size => '180x135', :alt=> "step_image", "class" => "lazy", "data-original" => s.get_image_url(:thumb) ), s.get_image_url, rel: "facebox" %>
                                <% else  %>
                                    <%= image_tag "grey.gif", "class" => 'lazy', "data-original"=> "/assets/not_found.png", :size => '180x135' %>
                                <% end %>
                            </span>
                            <span><%= s.content %></span>
                        </div>
                     <% end %>
                    </div>
                <% end %>
            </div>
        </div>
    </div>

     <div class="mt10">
        <%= render "comments/comments", item: @recipe %>
     </div>
</div>

<div class="grid_3 to_right">
    <%= render "users/author_panel", author: @recipe.author %>
    <div class="mt5"></div>
    <%= render "recipes/related_recipes", recipes: @related_recipes %>
    <div class="mt5"></div>
    <%= render "products/related_products", products: @related_products %>
</div>


<div id="review_linker" class="display_none">
    <%= form_tag url_for(controller: "recipes", action: "mark", id: @recipe.id, method: :post), :remote => true do %>
        <%= hidden_field_tag "behavior", "", id: "behavior" %>
        <span>顺便说两句吧</span>
        <p>
          <%= text_area_tag "content", "", :rows => 10, :columns => 30, :maxlength => get_max_length(Review, :content), 'data-comment_max_len' => get_max_length(Review, :content), :class => "char_aware" %>
          <%= content_tag :span, "", class: "char_saver display_none" %>
          <%= content_tag :span, "", class: "char_counter block trivial" %>
        </p>
        <%= submit_tag t("general.submit"), class: "button" %>
    <% end %>
</div>


