<% title t("reviews.edit_review" ), false %>

<% content_for :head do %>
    <%= stylesheet_link_tag "upload" %>
<% end %>

<div class="grid_9">
    <%= form_for @review do |f| %>
        <%= render "shared/error_messages", :target => @review %>
        <div class="block round p5 clearfix" id = "review_fields" >
            <h2><%= t("reviews.edit_review" ) %></h2>
            <%= f.text_area :content, :maxlength => get_max_length(@review, :content), 'data-comment_max_len' => get_max_length(@review, :content), :class => "char_aware" %>
            <%= content_tag :span, "", class: "char_saver display_none" %>
            <%= content_tag :span, "", class: "char_counter block trivial" %>

            <div>
                <span class="fl mr5">添加：</span>
                <!--image uploader-->
                <div class = "fl">
                    <%= hidden_field_tag "authenticity_token", form_authenticity_token, :id => "tokentag" %>
                    <div id="uploader" class="fl mr10"></div>
                    <div id="upload_spinner" style="display:none" ><%= image_tag "loading_big.gif", width: 24, height: 24 %></div>
                </div>

                <!--product linker-->
                <div class="fl mr10">
                    <%= link_to_function "添加商品", "link_product()", class: "btn btn_add_product lighter_touch"%>
                </div>

                <!--recipe linker-->
                <div class="fl mr10">
                  <%= link_to_function "添加菜谱", "link_recipe()", class: "btn btn_add_recipe lighter_touch"%>
                </div>


                <!--submit and sync to 3rd-->
                <div class = "fr">
                    <% unless current_user.provider == SELF_PROVIDER %>
                        <div class="fl">
                            <div class= "fl m5"><%= check_box_tag  :sync_to %><%= label_tag :sync_to, t("syncs.sync_to") %></div>
                            <div class= "fl m5">
                                <%= link_to t("syncs.sites.#{current_user.provider}"), "", class: "auth_btn_16 via_#{current_user.provider}_small", :border => 0, :alt => t("syncs.sites.#{current_user.provider}")%>
                            </div>
                        </div>
                    <%end%>
                    <div class= "fr m5"><%= f.submit t("general.update"), class: "button" %> </div>
                </div>
           </div>
           <div id="images_container" class="block fl m5" >
                <% @review.get_linked_items.each do |item| %>
                    <%= render "reviews/linked_item", item: item %>
                <% end %>

                <% @review.images.each do |image| %>
                    <div class="image fl">
                        <%= link_to "删除", "", onclick: "delete_related_item(this); return false;", class: "del_link btn btn_close lighter_touch" %>
                        <%= link_to image_tag("grey.gif", "data-original"=> image.picture_url(:thumb), alt: "缩略图", class: "lazy thumbnail"), image.picture_url, rel: "facebox" %>
                        <%= hidden_field_tag "images[]", image.id.to_s %>
                    </div>
                <% end %>
           </div>
        </div>
    <% end %>
</div>


<%= render "reviews/product_linker" %>
<%= render "reviews/recipe_linker" %>

<% content_for :foot do %>
    <%= javascript_tag "setup_review_img_uploader();" %>
<% end %>